pipeline {
    agent any

    environment {
        IMAGE_NAME = 'md-test-dev'
        POSTGRES_PASSWORD = credentials('postgres-password-dev')
        PROJECT_DIR = '/opt/nestjs-mind-awake/md-test'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} -t ${IMAGE_NAME}:latest ."
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                    docker run -d --name test_db_dev_${BUILD_NUMBER} \
                        -e POSTGRES_USER=test \
                        -e POSTGRES_PASSWORD=test \
                        -e POSTGRES_DB=test_db \
                        postgres:15-alpine

                    sleep 10

                    docker run --rm \
                        --link test_db_dev_${BUILD_NUMBER}:postgres \
                        -e DATABASE_URL=postgresql://test:test@postgres:5432/test_db?sslmode=disable \
                        ${IMAGE_NAME}:${BUILD_NUMBER} \
                        npm run test || true

                    docker stop test_db_dev_${BUILD_NUMBER}
                    docker rm test_db_dev_${BUILD_NUMBER}
                '''
            }
        }

        stage('Deploy to Development') {
            steps {
                sh '''
                    cd ${PROJECT_DIR}

                    # –û–±–Ω–æ–≤–ª—è–µ–º .env.dev
                    cat > .env.dev << EOF
POSTGRES_USER=myapp_dev
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
POSTGRES_DB=myapp_dev
NODE_ENV=development
PORT=3001
DATABASE_URL=postgresql://myapp_dev:${POSTGRES_PASSWORD}@postgres:5432/myapp_dev?sslmode=disable
EOF

                    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑
                    docker tag ${IMAGE_NAME}:${BUILD_NUMBER} ${IMAGE_NAME}:latest

                    # –î–µ–ø–ª–æ–∏–º
                    echo "üöÄ Deploying to development..."
                    docker-compose -f docker-compose.dev.yml up -d

                    sleep 15
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                    if curl -f http://localhost:3001 > /dev/null 2>&1; then
                        echo "‚úÖ Development is healthy"
                    else
                        echo "‚ùå Health check failed"
                        exit 1
                    fi
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ Development deployment successful!'
        }
        failure {
            echo '‚ùå Deployment failed!'
            sh "docker-compose -f ${PROJECT_DIR}/docker-compose.dev.yml logs --tail=50"
        }
        always {
            sh 'docker rm -f test_db_dev_${BUILD_NUMBER} || true'
        }
    }
}