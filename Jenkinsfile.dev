pipeline {
    agent any

    environment {
        IMAGE_NAME = 'md-test-dev'
        POSTGRES_PASSWORD = credentials('postgres-password-dev')
        PROJECT_DIR = '/opt/nestjs-mind-awake/md-test'
        DEV_NETWORK = 'md_test_dev_network'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                    echo "üîß Building Docker image..."
                    docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} -t ${IMAGE_NAME}:latest .
                """
            }
        }

        stage('Run Tests') {
            steps {
                sh """
                    echo "üß™ Starting temporary test database..."
                    docker run -d --name test_db_dev_${BUILD_NUMBER} \\
                        -e POSTGRES_USER=test \\
                        -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} \\
                        -e POSTGRES_DB=test_db \\
                        --network ${DEV_NETWORK} \\
                        postgres:15-alpine

                    sleep 10

                    echo "üèÉ Running tests..."
                    docker run --rm \\
                        --network ${DEV_NETWORK} \\
                        -e DATABASE_URL=postgresql://test:${POSTGRES_PASSWORD}@test_db_dev_${BUILD_NUMBER}:5432/test_db?sslmode=disable \\
                        ${IMAGE_NAME}:${BUILD_NUMBER} \\
                        npm run test

                    echo "üßπ Cleaning up test database..."
                    docker stop test_db_dev_${BUILD_NUMBER}
                    docker rm test_db_dev_${BUILD_NUMBER}
                """
            }
        }

        stage('Deploy to Development') {
            steps {
                sh """
                    cd ${PROJECT_DIR}

                    if [ ! -f .env.dev ]; then
                        echo "‚ùå .env.dev not found!"
                        exit 1
                    fi

                    echo "üîÑ Tagging latest image..."
                    docker tag ${IMAGE_NAME}:${BUILD_NUMBER} ${IMAGE_NAME}:latest

                    echo "üõë Stopping old development containers..."
                    docker-compose -f docker-compose.dev.yml --env-file .env.dev down --remove-orphans

                    echo "üöÄ Deploying new development containers..."
                    docker-compose -f docker-compose.dev.yml --env-file .env.dev up -d

                    echo "‚è≥ Waiting for services to start..."
                    sleep 20
                """
            }
        }

        stage('Health Check') {
            steps {
                sh """
                    echo "üè• Performing health check..."
                    sleep 10

                    if curl -f http://localhost:3001 > /dev/null 2>&1; then
                        echo "‚úÖ Development environment is healthy"
                    else
                        echo "‚ùå Health check failed! Showing logs:"
                        docker-compose -f ${PROJECT_DIR}/docker-compose.dev.yml --env-file ${PROJECT_DIR}/.env.dev logs --tail=50 nestjs
                        exit 1
                    fi
                """
            }
        }
    }

    post {
        success {
            echo '‚úÖ Development deployment successful!'
        }
        failure {
            echo '‚ùå Deployment failed!'
            sh "docker-compose -f ${PROJECT_DIR}/docker-compose.dev.yml logs --tail=50"
        }
        always {
            sh """
                echo "üßπ Cleanup leftover test containers..."
                docker rm -f test_db_dev_${BUILD_NUMBER} || true

                echo "üßπ Cleanup dangling dev images..."
                docker image prune -f --filter label=dev
            """
        }
    }
}
